<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enterprise Order Panel</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    /* Dark mode */
    .dark { background-color: #111827; color: #f9fafb; }
    .dark .card { background-color: #1f2937; border-color: #374151; }
    .dark input, .dark select { background-color: #374151; color: white; border-color: #4b5563; }
    /* Animations */
    .fade-enter { animation: fadeIn 0.2s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    /* Views */
    .view { display: none; }
    .view.active { display: block; }
    /* Virtual scroll */
    .virtual-scroll { height: 400px; overflow-y: auto; }
    /* Sidebar */
    .sidebar-open { transform: translateX(0); }
    .overlay { display: none; }
    .overlay.active { display: block; }
    /* Chart container */
    .chart-container { position: relative; height: 300px; width: 100%; }
  </style>
  <!-- Biblioteki -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.min.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

<!-- Sidebar -->
<div class="fixed inset-y-0 left-0 w-72 bg-white dark:bg-gray-800 shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out z-30 lg:translate-x-0" id="sidebar">
  <div class="p-6 flex flex-col h-full">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400"> OrderPanel</h2>
      <button onclick="closeSidebar()" class="lg:hidden text-gray-500 hover:text-gray-700 dark:text-gray-400">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <nav class="flex-1 space-y-2">
      <a href="#" onclick="showView('dashboard'); return false;" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded-lg transition sidebar-link" data-view="dashboard">
        <i class="fas fa-chart-pie w-6"></i> <span>Dashboard</span>
      </a>
      <a href="#" onclick="showView('orders'); return false;" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded-lg transition sidebar-link" data-view="orders">
        <i class="fas fa-shopping-cart w-6"></i> <span>Zam贸wienia</span>
      </a>
      <a href="#" onclick="showView('history'); return false;" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded-lg transition sidebar-link" data-view="history">
        <i class="fas fa-history w-6"></i> <span>Historia</span>
      </a>
      <a href="#" onclick="showView('stats'); return false;" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded-lg transition sidebar-link" data-view="stats">
        <i class="fas fa-chart-line w-6"></i> <span>Raporty</span>
      </a>
      <a href="#" onclick="showView('settings'); return false;" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded-lg transition sidebar-link" data-view="settings">
        <i class="fas fa-cog w-6"></i> <span>Ustawienia</span>
      </a>
      <a href="#" onclick="showView('admin'); return false;" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded-lg transition sidebar-link" data-view="admin">
        <i class="fas fa-user-cog w-6"></i> <span>Admin</span>
      </a>
    </nav>
    <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline"></i>
        </button>
        <button onclick="toggleLang()" class="px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          叼 / 
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay -->
<div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-20" onclick="closeSidebar()"></div>

<!-- Main content -->
<div class="lg:ml-72 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-10">
    <div class="px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button onclick="toggleSidebar()" class="lg:hidden text-gray-500 hover:text-gray-700 dark:text-gray-400">
          <i class="fas fa-bars text-2xl"></i>
        </button>
        <h1 class="text-xl font-semibold" id="page-title">Dashboard</h1>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-sm text-gray-600 dark:text-gray-400">Admin</span>
        <button onclick="showToast('Wylogowano (symulacja)', 'info')" class="text-sm text-red-600 hover:text-red-800">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Views container -->
  <main class="p-4 sm:p-6 lg:p-8 flex-1">
    <!-- Dashboard -->
    <div id="view-dashboard" class="view active">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
          <div class="text-sm text-gray-500 dark:text-gray-400">cznie zam贸wie</div>
          <div class="text-3xl font-bold" id="stat-total">0</div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
          <div class="text-sm text-gray-500">Odebrane</div>
          <div class="text-3xl font-bold text-green-600" id="stat-received">0</div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
          <div class="text-sm text-gray-500">Nieodebrane</div>
          <div class="text-3xl font-bold text-yellow-600" id="stat-pending">0</div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
          <div class="text-sm text-gray-500">r. czas realizacji</div>
          <div class="text-3xl font-bold" id="stat-avg">2.4d</div>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
        <h3 class="text-lg font-semibold mb-4">Zam贸wienia w czasie</h3>
        <div class="chart-container">
          <canvas id="ordersChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Orders -->
    <div id="view-orders" class="view">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700 mb-6">
        <form id="order-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <input type="text" id="order-name" placeholder="Nazwa" class="p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600" required>
          <input type="text" id="order-shop" placeholder="Sklep" class="p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600" required>
          <input type="date" id="order-date" class="p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600" required>
          <button type="submit" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition font-semibold">
            <i class="fas fa-plus mr-2"></i>Dodaj
          </button>
        </form>
      </div>

      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
        <div class="flex flex-wrap gap-3 mb-4 items-center">
          <div class="relative flex-1 min-w-[200px]">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            <input type="text" id="search-orders" placeholder="Szukaj..." class="w-full pl-10 p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600">
          </div>
          <select id="filter-status" class="p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600">
            <option value="all">Wszystkie</option>
            <option value="pending">Nieodebrane</option>
            <option value="received">Odebrane</option>
          </select>
          <select id="sort-by" class="p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600">
            <option value="date-desc">Data (najnowsze)</option>
            <option value="date-asc">Data (najstarsze)</option>
            <option value="shop">Sklep</option>
          </select>
          <button onclick="exportData('csv')" class="px-4 py-3 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
            <i class="fas fa-download mr-2"></i>CSV
          </button>
          <button onclick="exportData('xlsx')" class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <i class="fas fa-file-excel mr-2"></i>Excel
          </button>
          <button onclick="exportData('pdf')" class="px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600">
            <i class="fas fa-file-pdf mr-2"></i>PDF
          </button>
          <button onclick="document.getElementById('import-file').click()" class="px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
            <i class="fas fa-upload mr-2"></i>Import
          </button>
          <input type="file" id="import-file" accept=".csv, .xlsx" class="hidden">
        </div>

        <div class="virtual-scroll border rounded-lg dark:border-gray-700">
          <table class="w-full">
            <thead class="sticky top-0 bg-gray-100 dark:bg-gray-700">
              <tr>
                <th class="p-3 text-left">Nazwa</th>
                <th class="p-3 text-left">Sklep</th>
                <th class="p-3 text-left">Data</th>
                <th class="p-3 text-left">Status</th>
                <th class="p-3 text-left">Akcje</th>
              </tr>
            </thead>
            <tbody id="orders-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- History -->
    <div id="view-history" class="view">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
        <h3 class="text-lg font-semibold mb-4">Historia operacji</h3>
        <div class="space-y-2" id="history-list"></div>
      </div>
    </div>

    <!-- Stats -->
    <div id="view-stats" class="view">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
          <div class="chart-container">
            <canvas id="chart-shops"></canvas>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
          <div class="chart-container">
            <canvas id="chart-status"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings -->
    <div id="view-settings" class="view">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700 space-y-4">
        <h3 class="text-lg font-semibold">Ustawienia</h3>
        <div>
          <label class="flex items-center gap-2">
            <input type="checkbox" id="dark-mode-toggle" onchange="toggleTheme()"> 
            <span>Ciemny motyw</span>
          </label>
        </div>
        <div>
          <label class="flex items-center gap-2">
            <input type="checkbox" id="notifications-toggle"> 
            <span>Powiadomienia</span>
          </label>
        </div>
        <div>
          <button onclick="backupData()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
            <i class="fas fa-database mr-2"></i>Kopia zapasowa
          </button>
        </div>
        <div>
          <button onclick="restoreData()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
            <i class="fas fa-undo mr-2"></i>Przywr贸 dane
          </button>
        </div>
      </div>
    </div>

    <!-- Admin -->
    <div id="view-admin" class="view">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border dark:border-gray-700">
        <h3 class="text-lg font-semibold mb-4">Panel administratora</h3>
        <p class="text-gray-600 dark:text-gray-400">Symulacja: Zarzdzanie u偶ytkownikami (tylko dla admina)</p>
        <div class="mt-4">
          <button onclick="showToast('Akcja admina (symulacja)', 'success')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
            Usu wszystkich u偶ytkownik贸w (symulacja)
          </button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Toast container -->
<div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

<script>
  // ==================== INICJALIZACJA ====================
  const { openDB } = idb;
  let db;
  let orders = [];
  let history = [];
  let filter = 'all';
  let searchTerm = '';
  let sortBy = 'date-desc';
  let chartInstances = {
    dashboard: null,
    shops: null,
    status: null
  };

  // ==================== OBSUGA WIDOKW ====================
  window.showView = function(viewId) {
    // Ukryj wszystkie widoki
    document.querySelectorAll('.view').forEach(v => {
      v.classList.remove('active');
    });
    
    // Poka偶 wybrany widok
    const selectedView = document.getElementById(`view-${viewId}`);
    if (selectedView) {
      selectedView.classList.add('active');
    }
    
    // Aktualizuj tytu
    const titles = {
      dashboard: 'Dashboard',
      orders: 'Zam贸wienia',
      history: 'Historia',
      stats: 'Raporty',
      settings: 'Ustawienia',
      admin: 'Panel Admina'
    };
    document.getElementById('page-title').innerText = titles[viewId] || 'Dashboard';
    
    // Aktualizuj aktywny link w sidebarze
    document.querySelectorAll('.sidebar-link').forEach(link => {
      link.classList.remove('bg-indigo-50', 'dark:bg-gray-700');
      if (link.getAttribute('data-view') === viewId) {
        link.classList.add('bg-indigo-50', 'dark:bg-gray-700');
      }
    });
    
    // Renderuj odpowiedni widok
    if (viewId === 'dashboard') {
      setTimeout(() => renderDashboard(), 100); // Mae op贸藕nienie dla prawidowego renderowania wykresu
    }
    if (viewId === 'orders') renderOrders();
    if (viewId === 'history') renderHistory();
    if (viewId === 'stats') {
      setTimeout(() => renderStats(), 100);
    }
    
    // Zamknij sidebar na mobile
    if (window.innerWidth < 1024) {
      closeSidebar();
    }
  };

  // ==================== SIDEBAR ====================
  window.toggleSidebar = function() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    sidebar.classList.toggle('-translate-x-full');
    overlay.classList.toggle('hidden');
  };

  window.closeSidebar = function() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    sidebar.classList.add('-translate-x-full');
    overlay.classList.add('hidden');
  };

  // ==================== BAZA DANYCH ====================
  async function initDB() {
    db = await openDB('OrderPanelDB', 1, {
      upgrade(db) {
        if (!db.objectStoreNames.contains('orders')) {
          db.createObjectStore('orders', { keyPath: 'id', autoIncrement: true });
        }
        if (!db.objectStoreNames.contains('history')) {
          db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
        }
      }
    });
    
    // Zaaduj dane
    await loadOrders();
    await loadHistory();
    
    // Jeli nie ma danych, dodaj przykadowe
    if (orders.length === 0) {
      await addSampleData();
    }
    
    renderDashboard();
    renderOrders();
    renderHistory();
  }

  async function loadOrders() {
    orders = await db.getAll('orders');
    updateStats();
  }

  async function loadHistory() {
    history = await db.getAll('history');
    history.sort((a, b) => b.timestamp - a.timestamp);
  }

  async function addSampleData() {
    const sampleOrders = [
      { nazwa: 'Laptop Dell', sklep: 'X-kom', data: '2024-01-15', odebrane: true },
      { nazwa: 'Monitor Samsung', sklep: 'Media Expert', data: '2024-01-16', odebrane: false },
      { nazwa: 'Klawiatura Logitech', sklep: 'Morele', data: '2024-01-17', odebrane: true },
      { nazwa: 'Mysz Razer', sklep: 'X-kom', data: '2024-01-18', odebrane: false },
      { nazwa: 'Dysk SSD 1TB', sklep: 'Komputronik', data: '2024-01-19', odebrane: false },
      { nazwa: 'Karta graficzna', sklep: 'Morele', data: '2024-01-20', odebrane: true },
      { nazwa: 'Zasilacz', sklep: 'X-kom', data: '2024-01-21', odebrane: false }
    ];
    
    for (const order of sampleOrders) {
      await db.add('orders', order);
    }
    await loadOrders();
  }

  // ==================== OPERACJE NA DANYCH ====================
  window.addOrder = async function(order) {
    const id = await db.add('orders', { ...order, odebrane: false });
    await addHistory('add', `Dodano zam贸wienie: ${order.nazwa}`);
    await loadOrders();
    renderOrders();
    if (document.getElementById('view-dashboard').classList.contains('active')) {
      renderDashboard();
    }
    showToast('Dodano zam贸wienie', 'success');
  };

  window.toggleReceived = async function(id) {
    const order = orders.find(o => o.id === id);
    if (order) {
      order.odebrane = !order.odebrane;
      await db.put('orders', order);
      await addHistory('update', `Zmieniono status: ${order.nazwa}`);
      await loadOrders();
      renderOrders();
      if (document.getElementById('view-dashboard').classList.contains('active')) {
        renderDashboard();
      }
      showToast('Status zaktualizowany', 'success');
    }
  };

  window.editOrder = async function(id) {
    const order = orders.find(o => o.id === id);
    const newName = prompt('Nowa nazwa:', order.nazwa);
    if (newName && newName !== order.nazwa) {
      order.nazwa = newName;
      await db.put('orders', order);
      await addHistory('update', `Edytowano: ${order.nazwa}`);
      await loadOrders();
      renderOrders();
      if (document.getElementById('view-dashboard').classList.contains('active')) {
        renderDashboard();
      }
      showToast('Zaktualizowano', 'success');
    }
  };

  window.deleteOrder = async function(id) {
    if (confirm('Czy na pewno usun?')) {
      const order = orders.find(o => o.id === id);
      await db.delete('orders', id);
      await addHistory('delete', `Usunito: ${order.nazwa}`);
      await loadOrders();
      renderOrders();
      if (document.getElementById('view-dashboard').classList.contains('active')) {
        renderDashboard();
      }
      showToast('Usunito', 'info');
    }
  };

  async function addHistory(action, description) {
    const entry = { action, description, timestamp: Date.now() };
    await db.add('history', entry);
    await loadHistory();
    renderHistory();
  }

  // ==================== RENDEROWANIE ====================
  function renderOrders() {
    const tbody = document.getElementById('orders-tbody');
    if (!tbody) return;

    let filtered = orders.filter(o => {
      if (filter === 'pending' && o.odebrane) return false;
      if (filter === 'received' && !o.odebrane) return false;
      if (searchTerm && !`${o.nazwa} ${o.sklep}`.toLowerCase().includes(searchTerm.toLowerCase())) return false;
      return true;
    });

    filtered.sort((a, b) => {
      if (sortBy === 'date-desc') return new Date(b.data) - new Date(a.data);
      if (sortBy === 'date-asc') return new Date(a.data) - new Date(b.data);
      if (sortBy === 'shop') return a.sklep.localeCompare(b.sklep);
      return 0;
    });

    tbody.innerHTML = filtered.map(o => `<tr class="border-b dark:border-gray-700 ${o.odebrane ? 'line-through opacity-60' : ''}">
      <td class="p-3">${escapeHTML(o.nazwa)}</td>
      <td class="p-3">${escapeHTML(o.sklep)}</td>
      <td class="p-3">${o.data}</td>
      <td class="p-3">
        <span class="px-2 py-1 rounded-full text-xs ${o.odebrane ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
          ${o.odebrane ? 'Odebrane' : 'Nieodebrane'}
        </span>
      </td>
      <td class="p-3 space-x-2">
        <button onclick="toggleReceived(${o.id})" class="text-indigo-600 hover:text-indigo-800" title="Zmie status">
          <i class="fas fa-check-circle"></i>
        </button>
        <button onclick="editOrder(${o.id})" class="text-amber-600 hover:text-amber-800" title="Edytuj">
          <i class="fas fa-edit"></i>
        </button>
        <button onclick="deleteOrder(${o.id})" class="text-red-600 hover:text-red-800" title="Usu">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    </tr>`).join('');
  }

  function renderHistory() {
    const list = document.getElementById('history-list');
    if (!list) return;
    list.innerHTML = history.map(h => 
      `<div class="p-2 border-b dark:border-gray-700 text-sm">
        ${new Date(h.timestamp).toLocaleString()} - ${h.action}: ${h.description}
      </div>`
    ).join('');
  }

  function renderDashboard() {
    updateStats();
    
    const canvas = document.getElementById('ordersChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    // Zniszcz poprzedni wykres jeli istnieje
    if (chartInstances.dashboard) {
      chartInstances.dashboard.destroy();
    }
    
    // Generuj daty dla ostatnich 30 dni
    const last30Days = [];
    const counts = [];
    
    for (let i = 29; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      last30Days.push(dateStr);
      
      // Policz zam贸wienia z tego dnia
      const count = orders.filter(o => o.data === dateStr).length;
      counts.push(count);
    }
    
    // Znajd藕 maksymaln warto do skali
    const maxCount = Math.max(...counts, 1);
    
    chartInstances.dashboard = new Chart(ctx, {
      type: 'line',
      data: {
        labels: last30Days.map(date => {
          // Formatuj dat jako DD/MM
          const [year, month, day] = date.split('-');
          return `${day}.${month}`;
        }),
        datasets: [{
          label: 'Liczba zam贸wie',
          data: counts,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: '#3b82f6',
          tension: 0.1,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              title: function(context) {
                const index = context[0].dataIndex;
                return last30Days[index]; // Pena data w tooltipie
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: Math.ceil(maxCount * 1.2), // Dodaj 20% marginesu
            ticks: {
              stepSize: 1,
              precision: 0
            },
            title: {
              display: true,
              text: 'Liczba zam贸wie'
            }
          },
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45,
              maxTicksLimit: 15 // Ogranicz liczb etykiet na osi X
            }
          }
        }
      }
    });
  }

  function renderStats() {
    if (!document.getElementById('view-stats').classList.contains('active')) return;
    
    // Wykres sklepy
    const shopsCanvas = document.getElementById('chart-shops');
    if (shopsCanvas) {
      const shops = {};
      orders.forEach(o => shops[o.sklep] = (shops[o.sklep] || 0) + 1);
      
      if (chartInstances.shops) chartInstances.shops.destroy();
      
      chartInstances.shops = new Chart(shopsCanvas, {
        type: 'bar',
        data: {
          labels: Object.keys(shops),
          datasets: [{
            label: 'Zam贸wienia',
            data: Object.values(shops),
            backgroundColor: '#3b82f6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    // Wykres status
    const statusCanvas = document.getElementById('chart-status');
    if (statusCanvas) {
      if (chartInstances.status) chartInstances.status.destroy();
      
      chartInstances.status = new Chart(statusCanvas, {
        type: 'doughnut',
        data: {
          labels: ['Odebrane', 'Nieodebrane'],
          datasets: [{
            data: [orders.filter(o => o.odebrane).length, orders.filter(o => !o.odebrane).length],
            backgroundColor: ['#10b981', '#f59e0b']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }
  }

  function updateStats() {
    document.getElementById('stat-total').innerText = orders.length;
    document.getElementById('stat-received').innerText = orders.filter(o => o.odebrane).length;
    document.getElementById('stat-pending').innerText = orders.filter(o => !o.odebrane).length;
    
    // Oblicz redni czas realizacji (dla odebranych zam贸wie)
    const receivedOrders = orders.filter(o => o.odebrane);
    if (receivedOrders.length > 0) {
      const today = new Date();
      let totalDays = 0;
      receivedOrders.forEach(o => {
        const orderDate = new Date(o.data);
        const days = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
        totalDays += days;
      });
      const avgDays = (totalDays / receivedOrders.length).toFixed(1);
      document.getElementById('stat-avg').innerText = avgDays + 'd';
    }
  }

  function escapeHTML(str) {
    return String(str).replace(/[&<>"]/g, function(m) {
      if (m === '&') return '&amp;';
      if (m === '<') return '&lt;';
      if (m === '>') return '&gt;';
      if (m === '"') return '&quot;';
      return m;
    });
  }

  // ==================== FORMULARZ ====================
  document.getElementById('order-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const nazwa = document.getElementById('order-name').value;
    const sklep = document.getElementById('order-shop').value;
    const data = document.getElementById('order-date').value;
    
    if (!nazwa || !sklep || !data) {
      showToast('Wypenij wszystkie pola', 'error');
      return;
    }
    
    await window.addOrder({ nazwa, sklep, data });
    e.target.reset();
  });

  // ==================== FILTRY ====================
  document.getElementById('filter-status')?.addEventListener('change', e => {
    filter = e.target.value;
    renderOrders();
  });
  
  document.getElementById('search-orders')?.addEventListener('input', e => {
    searchTerm = e.target.value;
    renderOrders();
  });
  
  document.getElementById('sort-by')?.addEventListener('change', e => {
    sortBy = e.target.value;
    renderOrders();
  });

  // ==================== EKSPORT ====================
  window.exportData = async function(format) {
    const data = orders.map(o => [o.nazwa, o.sklep, o.data, o.odebrane ? 'Odebrane' : 'Nieodebrane']);
    
    if (format === 'csv') {
      const csv = 'Nazwa,Sklep,Data,Status\n' + data.map(row => row.join(',')).join('\n');
      download(csv, 'orders.csv', 'text/csv');
    } else if (format === 'xlsx') {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([['Nazwa','Sklep','Data','Status'], ...data]);
      XLSX.utils.book_append_sheet(wb, ws, 'Orders');
      XLSX.writeFile(wb, 'orders.xlsx');
    } else if (format === 'pdf') {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text('Zam贸wienia', 10, 10);
      let y = 20;
      data.forEach(row => {
        doc.text(row.join(' | '), 10, y);
        y += 10;
      });
      doc.save('orders.pdf');
    }
    showToast(`Eksport ${format} wykonany`, 'success');
  };

  document.getElementById('import-file')?.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async (e) => {
      const content = e.target.result;
      
      if (file.name.endsWith('.csv')) {
        const lines = content.split('\n').slice(1);
        for (const line of lines) {
          if (!line.trim()) continue;
          const [nazwa, sklep, data, status] = line.split(',');
          await window.addOrder({
            nazwa: nazwa?.trim() || '',
            sklep: sklep?.trim() || '',
            data: data?.trim() || new Date().toISOString().split('T')[0]
          });
        }
      }
      showToast('Import zakoczony', 'success');
    };
    
    reader.readAsText(file);
  });

  function download(content, fileName, mimeType) {
    const a = document.createElement('a');
    const blob = new Blob([content], { type: mimeType });
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ==================== USTAWIENIA ====================
  window.toggleTheme = function() {
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  };

  window.toggleLang = function() {
    showToast('Zmiana jzyka (symulacja)', 'info');
  };

  window.backupData = function() {
    const data = JSON.stringify(orders);
    download(data, 'backup.json', 'application/json');
  };

  window.restoreData = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = async (e) => {
        const newOrders = JSON.parse(e.target.result);
        for (const o of newOrders) {
          await db.add('orders', o);
        }
        await loadOrders();
        renderOrders();
        if (document.getElementById('view-dashboard').classList.contains('active')) {
          renderDashboard();
        }
        showToast('Przywr贸cono dane', 'success');
      };
      reader.readAsText(file);
    };
    input.click();
  };

  // ==================== TOASTY ====================
  window.showToast = function(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `px-4 py-3 rounded-lg shadow-lg text-white fade-enter ${
      type === 'success' ? 'bg-green-500' : 
      type === 'error' ? 'bg-red-500' : 
      'bg-blue-500'
    }`;
    toast.innerText = message;
    document.getElementById('toast-container').appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  };

  // ==================== SKRTY KLAWISZOWE ====================
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'd') {
      e.preventDefault();
      showView('dashboard');
    }
    if (e.ctrlKey && e.key === 'o') {
      e.preventDefault();
      showView('orders');
    }
  });

  // ==================== START ====================
  // Inicjalizacja motywu
  if (localStorage.getItem('theme') === 'light') {
    document.documentElement.classList.remove('dark');
  } else {
    document.documentElement.classList.add('dark');
  }

  // Start aplikacji
  initDB();

  // Ustaw dashboard jako aktywny
  document.querySelector('.sidebar-link[data-view="dashboard"]').classList.add('bg-indigo-50', 'dark:bg-gray-700');

  // Nasuchiwanie zmiany rozmiaru okna dla wykres贸w
  window.addEventListener('resize', () => {
    if (document.getElementById('view-dashboard').classList.contains('active')) {
      renderDashboard();
    }
    if (document.getElementById('view-stats').classList.contains('active')) {
      renderStats();
    }
  });
</script>
</body>
</html>
