<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enterprise Order Panel</title>
  <!-- Manifest PWA -->
  <link rel="manifest" href="data:application/manifest+json,{
    &quot;name&quot;: &quot;Enterprise Order Panel&quot;,
    &quot;short_name&quot;: &quot;Orders&quot;,
    &quot;start_url&quot;: &quot;.&quot;,
    &quot;display&quot;: &quot;standalone&quot;,
    &quot;background_color&quot;: &quot;#111827&quot;,
    &quot;theme_color&quot;: &quot;#3b82f6&quot;,
    &quot;icons&quot;: [{ &quot;src&quot;: &quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233b82f6'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3E%3C/text%3E%3C/svg%3E&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/svg+xml&quot; }] }">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    /* Dark mode variables */
    :root { --bg-primary: #f9fafb; --bg-secondary: #ffffff; --text-primary: #111827; --text-secondary: #4b5563; --border: #e5e7eb; }
    .dark { --bg-primary: #111827; --bg-secondary: #1f2937; --text-primary: #f9fafb; --text-secondary: #d1d5db; --border: #374151; }
    body { background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
    .card { background-color: var(--bg-secondary); border: 1px solid var(--border); }
    /* Accessibility focus outline */
    *:focus-visible { outline: 2px solid #3b82f6; outline-offset: 2px; }
    /* Animations */
    .fade-enter { animation: fadeIn 0.2s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    /* Virtual scroll container */
    .virtual-scroll { height: 400px; overflow-y: auto; contain: strict; }
    /* Views */
    .view { display: none; }
    .view.active { display: block; }
  </style>
  <!-- Biblioteki -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.min.js"></script>
</head>
<body class="dark:bg-gray-900 dark:text-gray-100">

<!-- Sidebar -->
<div class="fixed inset-y-0 left-0 w-72 bg-white dark:bg-gray-800 shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out z-30 lg:translate-x-0 lg:static lg:shadow-none" id="sidebar">
  <div class="p-6 flex flex-col h-full">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400"> OrderPanel</h2>
      <button onclick="toggleSidebar()" class="lg:hidden text-gray-500 hover:text-gray-700 dark:text-gray-400" aria-label="Zamknij menu"><i class="fas fa-times text-xl"></i></button>
    </div>
    <nav class="flex-1 space-y-2" role="navigation" aria-label="G贸wne menu">
      <a href="#/dashboard" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded-lg transition sidebar-link" data-view="dashboard">
        <i class="fas fa-chart-pie w-6"></i> <span data-i18n="dashboard">Dashboard</span>
      </a>
      <a href="#/orders" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded-lg transition sidebar-link" data-view="orders">
        <i class="fas fa-shopping-cart w-6"></i> <span data-i18n="orders">Zam贸wienia</span>
      </a>
      <a href="#/history" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded-lg transition sidebar-link" data-view="history">
        <i class="fas fa-history w-6"></i> <span data-i18n="history">Historia</span>
      </a>
      <a href="#/stats" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded-lg transition sidebar-link" data-view="stats">
        <i class="fas fa-chart-line w-6"></i> <span data-i18n="stats">Raporty</span>
      </a>
      <a href="#/settings" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded-lg transition sidebar-link" data-view="settings">
        <i class="fas fa-cog w-6"></i> <span data-i18n="settings">Ustawienia</span>
      </a>
      <a href="#/admin" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded-lg transition sidebar-link" data-view="admin">
        <i class="fas fa-user-cog w-6"></i> <span data-i18n="admin">Admin</span>
      </a>
    </nav>
    <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="Przecz motyw">
          <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline"></i>
        </button>
        <button onclick="toggleLang()" class="px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="Zmie jzyk">
          叼 / 
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay dla mobile -->
<div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-20" onclick="toggleSidebar()" aria-hidden="true"></div>

<!-- G贸wna zawarto -->
<div class="flex-1 lg:ml-72 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-10">
    <div class="px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button onclick="toggleSidebar()" class="lg:hidden text-gray-500 hover:text-gray-700 dark:text-gray-400" aria-label="Otw贸rz menu">
          <i class="fas fa-bars text-2xl"></i>
        </button>
        <h1 class="text-xl font-semibold" id="page-title">Dashboard</h1>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-sm text-gray-600 dark:text-gray-400" id="user-role" aria-label="Zalogowano jako">Admin</span>
        <button onclick="simulateLogout()" class="text-sm text-red-600 hover:text-red-800 dark:text-red-400">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- G贸wny kontener widok贸w -->
  <main class="p-4 sm:p-6 lg:p-8 flex-1">
    <!-- Dashboard -->
    <section id="view-dashboard" class="view">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-6 rounded-xl shadow-sm">
          <div class="text-sm text-gray-500 dark:text-gray-400" data-i18n="totalOrders">cznie zam贸wie</div>
          <div class="text-3xl font-bold" id="stat-total">0</div>
        </div>
        <div class="card p-6 rounded-xl shadow-sm">
          <div class="text-sm text-gray-500" data-i18n="received">Odebrane</div>
          <div class="text-3xl font-bold text-green-600" id="stat-received">0</div>
        </div>
        <div class="card p-6 rounded-xl shadow-sm">
          <div class="text-sm text-gray-500" data-i18n="pending">Nieodebrane</div>
          <div class="text-3xl font-bold text-yellow-600" id="stat-pending">0</div>
        </div>
        <div class="card p-6 rounded-xl shadow-sm">
          <div class="text-sm text-gray-500" data-i18n="avgTime">r. czas realizacji</div>
          <div class="text-3xl font-bold" id="stat-avg">2.4d</div>
        </div>
      </div>
      <div class="card p-6 rounded-xl shadow-sm">
        <h3 class="text-lg font-semibold mb-4" data-i18n="ordersChart">Zam贸wienia w czasie</h3>
        <canvas id="ordersChart" width="400" height="200"></canvas>
      </div>
    </section>

    <!-- Zam贸wienia -->
    <section id="view-orders" class="view">
      <div class="card p-6 rounded-xl shadow-sm mb-6">
        <form id="order-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <input type="text" id="order-name" placeholder="Nazwa" class="p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600" required>
          <input type="text" id="order-shop" placeholder="Sklep" class="p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600" required>
          <input type="date" id="order-date" class="p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600" required>
          <button type="submit" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition font-semibold">
            <i class="fas fa-plus mr-2"></i><span data-i18n="addOrder">Dodaj</span>
          </button>
        </form>
      </div>

      <div class="card p-6 rounded-xl shadow-sm">
        <div class="flex flex-wrap gap-3 mb-4 items-center">
          <div class="relative flex-1 min-w-[200px]">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            <input type="text" id="search-orders" placeholder="Szukaj..." class="w-full pl-10 p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600">
          </div>
          <select id="filter-status" class="p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600">
            <option value="all">Wszystkie</option>
            <option value="pending">Nieodebrane</option>
            <option value="received">Odebrane</option>
          </select>
          <select id="sort-by" class="p-3 border rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600">
            <option value="date-desc">Data (najnowsze)</option>
            <option value="date-asc">Data (najstarsze)</option>
            <option value="shop">Sklep</option>
          </select>
          <button onclick="exportData('csv')" class="px-4 py-3 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
            <i class="fas fa-download mr-2"></i>CSV
          </button>
          <button onclick="exportData('xlsx')" class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <i class="fas fa-file-excel mr-2"></i>Excel
          </button>
          <button onclick="exportData('pdf')" class="px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600">
            <i class="fas fa-file-pdf mr-2"></i>PDF
          </button>
          <button onclick="document.getElementById('import-file').click()" class="px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
            <i class="fas fa-upload mr-2"></i>Import
          </button>
          <input type="file" id="import-file" accept=".csv, .xlsx" class="hidden" onchange="importData(event)">
        </div>

        <!-- Virtual scroll dla du偶ej listy -->
        <div class="virtual-scroll border rounded-lg" id="orders-container">
          <table class="w-full">
            <thead class="sticky top-0 bg-gray-100 dark:bg-gray-800">
              <tr>
                <th class="p-3 text-left">Nazwa</th>
                <th class="p-3 text-left">Sklep</th>
                <th class="p-3 text-left">Data</th>
                <th class="p-3 text-left">Status</th>
                <th class="p-3 text-left">Tagi</th>
                <th class="p-3 text-left">Akcje</th>
              </tr>
            </thead>
            <tbody id="orders-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Historia zmian -->
    <section id="view-history" class="view">
      <div class="card p-6 rounded-xl shadow-sm">
        <h3 class="text-lg font-semibold mb-4" data-i18n="historyLog">Historia operacji</h3>
        <div class="space-y-2" id="history-list"></div>
      </div>
    </section>

    <!-- Raporty -->
    <section id="view-stats" class="view">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-6 rounded-xl shadow-sm">
          <canvas id="chart-shops"></canvas>
        </div>
        <div class="card p-6 rounded-xl shadow-sm">
          <canvas id="chart-status"></canvas>
        </div>
      </div>
    </section>

    <!-- Ustawienia -->
    <section id="view-settings" class="view">
      <div class="card p-6 rounded-xl shadow-sm space-y-4">
        <h3 class="text-lg font-semibold" data-i18n="settings">Ustawienia</h3>
        <div>
          <label class="flex items-center gap-2">
            <input type="checkbox" id="dark-mode-toggle" onchange="toggleTheme()"> 
            <span data-i18n="darkMode">Ciemny motyw</span>
          </label>
        </div>
        <div>
          <label class="flex items-center gap-2">
            <input type="checkbox" id="notifications-toggle"> 
            <span data-i18n="notifications">Powiadomienia</span>
          </label>
        </div>
        <div>
          <button onclick="backupData()" class="bg-indigo-600 text-white px-4 py-2 rounded">
            <i class="fas fa-database mr-2"></i>Kopia zapasowa
          </button>
        </div>
        <div>
          <button onclick="restoreData()" class="bg-indigo-600 text-white px-4 py-2 rounded">
            <i class="fas fa-undo mr-2"></i>Przywr贸 dane
          </button>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="view-admin" class="view">
      <div class="card p-6 rounded-xl shadow-sm">
        <h3 class="text-lg font-semibold mb-4" data-i18n="adminPanel">Panel administratora</h3>
        <p>Symulacja: Zarzdzanie u偶ytkownikami (tylko dla admina)</p>
        <div class="mt-4">
          <button onclick="simulateAdminAction()" class="bg-red-600 text-white px-4 py-2 rounded">
            Usu wszystkich u偶ytkownik贸w (symulacja)
          </button>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Toast notifications -->
<div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

<!-- G贸wny skrypt aplikacji -->
<script>
  (function() {
    // ==================== KONFIGURACJA ====================
    const { openDB } = idb;

    // Baza danych IndexedDB
    let db;
    const DB_NAME = 'OrderPanelDB';
    const STORE_ORDERS = 'orders';
    const STORE_HISTORY = 'history';

    // Stan aplikacji
    let currentView = 'dashboard';
    let orders = [];
    let history = [];
    let filter = 'all';
    let searchTerm = '';
    let sortBy = 'date-desc';
    let lang = 'pl';
    let darkMode = true;

    const i18n = {
      pl: { 
        dashboard: 'Dashboard', 
        orders: 'Zam贸wienia', 
        history: 'Historia', 
        stats: 'Raporty',
        settings: 'Ustawienia', 
        admin: 'Admin',
        totalOrders: 'cznie zam贸wie', 
        received: 'Odebrane', 
        pending: 'Nieodebrane', 
        addOrder: 'Dodaj zam贸wienie',
        historyLog: 'Historia operacji',
        adminPanel: 'Panel administratora',
        darkMode: 'Ciemny motyw',
        notifications: 'Powiadomienia',
        avgTime: 'r. czas realizacji',
        ordersChart: 'Zam贸wienia w czasie'
      },
      en: { 
        dashboard: 'Dashboard', 
        orders: 'Orders', 
        history: 'History', 
        stats: 'Reports',
        settings: 'Settings', 
        admin: 'Admin',
        totalOrders: 'Total orders', 
        received: 'Received', 
        pending: 'Pending', 
        addOrder: 'Add order',
        historyLog: 'History log',
        adminPanel: 'Admin panel',
        darkMode: 'Dark mode',
        notifications: 'Notifications',
        avgTime: 'Avg. completion time',
        ordersChart: 'Orders over time'
      }
    };

    // ==================== INICJALIZACJA ====================
    async function initDB() {
      db = await openDB(DB_NAME, 2, {
        upgrade(db, oldVersion) {
          if (!db.objectStoreNames.contains(STORE_ORDERS)) {
            const store = db.createObjectStore(STORE_ORDERS, { keyPath: 'id', autoIncrement: true });
            store.createIndex('date', 'data');
            store.createIndex('status', 'odebrane');
            store.createIndex('shop', 'sklep');
          }
          if (!db.objectStoreNames.contains(STORE_HISTORY)) {
            const hist = db.createObjectStore(STORE_HISTORY, { keyPath: 'id', autoIncrement: true });
            hist.createIndex('timestamp', 'timestamp');
          }
        }
      });
    }

    // ==================== OPERACJE NA DANYCH ====================
    async function loadOrders() {
      orders = await db.getAll(STORE_ORDERS);
      orders.sort((a, b) => new Date(b.data) - new Date(a.data));
      updateDashboardStats();
      renderOrdersTable();
    }

    async function loadHistory() {
      history = await db.getAll(STORE_HISTORY);
      history.sort((a, b) => b.timestamp - a.timestamp);
      renderHistory();
    }

    async function addOrder(order) {
      const id = await db.add(STORE_ORDERS, { ...order, odebrane: false });
      await addHistory('add', `Dodano zam贸wienie: ${order.nazwa}`);
      await loadOrders();
      showToast('Dodano zam贸wienie', 'success');
    }

    async function updateOrder(id, changes) {
      const order = await db.get(STORE_ORDERS, id);
      Object.assign(order, changes);
      await db.put(STORE_ORDERS, order);
      await addHistory('update', `Zaktualizowano zam贸wienie ${order.nazwa}`);
      await loadOrders();
    }

    async function deleteOrder(id) {
      const order = await db.get(STORE_ORDERS, id);
      await db.delete(STORE_ORDERS, id);
      await addHistory('delete', `Usunito zam贸wienie: ${order.nazwa}`);
      await loadOrders();
      showToast('Usunito zam贸wienie', 'info');
    }

    async function addHistory(action, description) {
      const entry = { action, description, timestamp: Date.now(), user: 'admin' };
      await db.add(STORE_HISTORY, entry);
      await loadHistory();
    }

    // ==================== RENDEROWANIE ====================
    function renderOrdersTable() {
      const tbody = document.getElementById('orders-tbody');
      if (!tbody) return;

      let filtered = orders.filter(o => {
        if (filter === 'pending' && o.odebrane) return false;
        if (filter === 'received' && !o.odebrane) return false;
        if (searchTerm && !`${o.nazwa} ${o.sklep}`.toLowerCase().includes(searchTerm.toLowerCase())) return false;
        return true;
      });

      // Sortowanie
      filtered.sort((a, b) => {
        if (sortBy === 'date-desc') return new Date(b.data) - new Date(a.data);
        if (sortBy === 'date-asc') return new Date(a.data) - new Date(b.data);
        if (sortBy === 'shop') return a.sklep.localeCompare(b.sklep);
        return 0;
      });

      tbody.innerHTML = filtered.map(o => `<tr class="border-b dark:border-gray-700 ${o.odebrane ? 'line-through opacity-60' : ''}">
        <td class="p-3">${escapeHTML(o.nazwa)}</td>
        <td class="p-3">${escapeHTML(o.sklep)}</td>
        <td class="p-3">${o.data}</td>
        <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${o.odebrane ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${o.odebrane ? 'Odebrane' : 'Nieodebrane'}</span></td>
        <td class="p-3">${(o.tags || []).map(t => `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs mr-1">${t}</span>`).join('')}</td>
        <td class="p-3 space-x-2">
          <button onclick="window.toggleReceived(${o.id})" class="text-indigo-600 hover:text-indigo-800" title="Zmie status"><i class="fas fa-check-circle"></i></button>
          <button onclick="window.editOrder(${o.id})" class="text-amber-600 hover:text-amber-800" title="Edytuj"><i class="fas fa-edit"></i></button>
          <button onclick="window.deleteOrder(${o.id})" class="text-red-600 hover:text-red-800" title="Usu"><i class="fas fa-trash"></i></button>
        </td>
      </tr>`).join('');
    }

    function escapeHTML(str) {
      return String(str).replace(/[&<>"]/g, function(m) {
        if (m === '&') return '&amp;'; 
        if (m === '<') return '&lt;'; 
        if (m === '>') return '&gt;'; 
        if (m === '"') return '&quot;';
        return m;
      });
    }

    function renderHistory() {
      const list = document.getElementById('history-list');
      if (!list) return;
      list.innerHTML = history.map(h => `<div class="p-2 border-b dark:border-gray-700 text-sm">${new Date(h.timestamp).toLocaleString()} - ${h.action}: ${h.description}</div>`).join('');
    }

    // ==================== WIDOK DASHBOARD ====================
    let chartInstance;
    function renderDashboard() {
      updateDashboardStats();
      
      // Wykres
      const ctx = document.getElementById('ordersChart')?.getContext('2d');
      if (!ctx) return;
      
      if (chartInstance) chartInstance.destroy();
      
      const last7Days = [...Array(7)].map((_, i) => {
        const d = new Date(); 
        d.setDate(d.getDate() - i);
        return d.toISOString().split('T')[0];
      }).reverse();
      
      const data = last7Days.map(date => orders.filter(o => o.data === date).length);
      
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: { 
          labels: last7Days, 
          datasets: [{ 
            label: 'Zam贸wienia', 
            data, 
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4
          }] 
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    function updateDashboardStats() {
      document.getElementById('stat-total').innerText = orders.length;
      document.getElementById('stat-received').innerText = orders.filter(o => o.odebrane).length;
      document.getElementById('stat-pending').innerText = orders.filter(o => !o.odebrane).length;
    }

    // ==================== WIDOK RAPORTW ====================
    let shopsChart, statusChart;
    function renderStats() {
      if (document.getElementById('view-stats').classList.contains('active')) {
        // Wykres sklepy
        const shops = {};
        orders.forEach(o => shops[o.sklep] = (shops[o.sklep] || 0) + 1);
        
        if (shopsChart) shopsChart.destroy();
        shopsChart = new Chart(document.getElementById('chart-shops'), { 
          type: 'bar', 
          data: { 
            labels: Object.keys(shops), 
            datasets: [{ 
              label: 'Zam贸wienia', 
              data: Object.values(shops),
              backgroundColor: '#3b82f6'
            }] 
          } 
        });

        // Wykres status
        if (statusChart) statusChart.destroy();
        statusChart = new Chart(document.getElementById('chart-status'), { 
          type: 'doughnut', 
          data: { 
            labels: ['Odebrane', 'Nieodebrane'], 
            datasets: [{ 
              data: [orders.filter(o=>o.odebrane).length, orders.filter(o=>!o.odebrane).length], 
              backgroundColor: ['#10b981', '#f59e0b'] 
            }] 
          } 
        });
      }
    }

    // ==================== ROUTING ====================
    function handleRoute() {
      const hash = window.location.hash.slice(1) || '/dashboard';
      const view = hash.split('/')[1] || 'dashboard';
      showView(view);
    }

    function showView(viewId) {
      // Ukryj wszystkie widoki
      document.querySelectorAll('.view').forEach(v => {
        v.classList.remove('active');
      });
      
      // Poka偶 wybrany widok
      const selectedView = document.getElementById(`view-${viewId}`);
      if (selectedView) {
        selectedView.classList.add('active');
      } else {
        // Domylnie poka偶 dashboard jeli widok nie istnieje
        document.getElementById('view-dashboard').classList.add('active');
        viewId = 'dashboard';
      }
      
      // Aktualizuj tytu
      document.getElementById('page-title').innerText = i18n[lang][viewId] || viewId;
      
      // Aktualizuj aktywny link w sidebarze
      document.querySelectorAll('.sidebar-link').forEach(link => {
        if (link.dataset.view === viewId) {
          link.classList.add('bg-indigo-50', 'dark:bg-gray-700');
        } else {
          link.classList.remove('bg-indigo-50', 'dark:bg-gray-700');
        }
      });
      
      currentView = viewId;
      
      // Renderuj odpowiedni widok
      if (viewId === 'dashboard') renderDashboard();
      if (viewId === 'orders') renderOrdersTable();
      if (viewId === 'history') renderHistory();
      if (viewId === 'stats') renderStats();
    }

    // ==================== OBSUGA FORMULARZA ====================
    document.getElementById('order-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const nazwa = document.getElementById('order-name').value;
      const sklep = document.getElementById('order-shop').value;
      const data = document.getElementById('order-date').value;
      
      if (!nazwa || !sklep || !data) {
        showToast('Wypenij wszystkie pola', 'error');
        return;
      }
      
      await addOrder({ nazwa, sklep, data, tags: [] });
      e.target.reset();
    });

    // Filtrowanie i wyszukiwanie
    document.getElementById('filter-status')?.addEventListener('change', e => { 
      filter = e.target.value; 
      renderOrdersTable(); 
    });
    
    document.getElementById('search-orders')?.addEventListener('input', e => { 
      searchTerm = e.target.value; 
      renderOrdersTable(); 
    });
    
    document.getElementById('sort-by')?.addEventListener('change', e => { 
      sortBy = e.target.value; 
      renderOrdersTable(); 
    });

    // ==================== EKSPORT / IMPORT ====================
    window.exportData = async (format) => {
      const data = orders.map(o => [o.nazwa, o.sklep, o.data, o.odebrane ? 'Odebrane' : 'Nieodebrane']);
      
      if (format === 'csv') {
        const csv = 'Nazwa,Sklep,Data,Status\n' + data.map(row => row.join(',')).join('\n');
        download(csv, 'orders.csv', 'text/csv');
      } else if (format === 'xlsx') {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([['Nazwa','Sklep','Data','Status'], ...data]);
        XLSX.utils.book_append_sheet(wb, ws, 'Orders');
        XLSX.writeFile(wb, 'orders.xlsx');
      } else if (format === 'pdf') {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text('Zam贸wienia', 10, 10);
        let y = 20;
        data.forEach(row => { 
          doc.text(row.join(' | '), 10, y); 
          y += 10; 
        });
        doc.save('orders.pdf');
      }
      showToast(`Eksport ${format} wykonany`, 'success');
    };

    window.importData = async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        const content = e.target.result;
        
        if (file.name.endsWith('.csv')) {
          const lines = content.split('\n').slice(1);
          for (const line of lines) {
            if (!line.trim()) continue;
            const [nazwa, sklep, data, status] = line.split(',');
            await addOrder({ 
              nazwa: nazwa.trim(), 
              sklep: sklep.trim(), 
              data: data.trim(), 
              odebrane: status?.trim() === 'Odebrane' 
            });
          }
        } else {
          const wb = XLSX.read(content, { type: 'binary' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { header: 1 }).slice(1);
          for (const row of rows) {
            if (row.length < 3) continue;
            await addOrder({ 
              nazwa: row[0], 
              sklep: row[1], 
              data: row[2], 
              odebrane: row[3] === 'Odebrane' 
            });
          }
        }
        showToast('Import zakoczony', 'success');
        renderOrdersTable();
      };
      
      if (file.name.endsWith('.csv')) {
        reader.readAsText(file);
      } else {
        reader.readAsBinaryString(file);
      }
    };

    function download(content, fileName, mimeType) {
      const a = document.createElement('a');
      const blob = new Blob([content], { type: mimeType });
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ==================== TOASTY ====================
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className
